<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
  <meta charset="utf-8">

  <title>Microarray analysis (solutions)</title>
  <meta name="description" content="">

  <!-- Mobile viewport optimized: h5bp.com/viewport -->
  <meta name="viewport" content="width=device-width">

  <!-- Tell iOS to run as an app if launched from home screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/page.css">
  <link rel="stylesheet" href="css/code.css">
  <link rel="stylesheet" href="css/print.css">

  <!-- All JavaScript at the bottom, except this Modernizr build. -->
  <script src="js/vendor/modernizr-2.5.3.min.js" type="text/javascript"></script>
</head>

<body>
  <!-- Prompt IE 6 users to install Chrome Frame. -->
  <!--[if lt IE 9]>
    <p class=chromeframe>
      Your web browser is <em>ancient!</em> <a href="http://browsehappy.com/">You should upgrade to a new browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.
    </p>
  <![endif]-->

  <!-- courseR content will be injected here -->
  <div id = "courser-stuff" class = "pageView">
<section>  <h1>Microarray analysis</h1>

<p>In the sections below you&#39;ll find some reference implementations of several functions which will be of use to you in analyzing microarray datasets.</p>
</section>
<section><h1>Loading multiple files</h1>

<p>In the implementation below, you&#39;ll see an example function which loads microarray data from multiple input files.</p>

<pre class="knitr"><div class="source"><span class="symbol">loadTables</span> <span class="assignement">&lt;-</span> <span class="keyword">function</span><span class="keyword">(</span><span class="formalargs">dataPath</span><span class="keyword">)</span> <span class="keyword">{</span>

  <span class="comment">#Load each .txt file in the path, parse the table with read.delim</span>
  <span class="symbol">tables</span> <span class="assignement">&lt;-</span> <span class="functioncall">list</span><span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">for</span> <span class="keyword">(</span><span class="symbol">fileName</span> <span class="keyword">in</span> <span class="functioncall">list.files</span><span class="keyword">(</span><span class="symbol">dataPath</span><span class="keyword">,</span> <span class="argument">pattern</span> <span class="argument">=</span> <span class="string">".txt"</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">{</span>
    <span class="symbol">tables</span><span class="keyword">[[</span><span class="symbol">fileName</span><span class="keyword">]</span><span class="keyword">]</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.delim</span><span class="keyword">(</span><span class="functioncall">paste</span><span class="keyword">(</span><span class="symbol">dataPath</span><span class="keyword">,</span> <span class="symbol">fileName</span><span class="keyword">,</span> <span class="argument">sep</span> <span class="argument">=</span> <span class="string">"/"</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">}</span>

  <span class="functioncall">return</span><span class="keyword">(</span><span class="symbol">tables</span><span class="keyword">)</span>

<span class="keyword">}</span></div></pre>
</section>
<section><h1>Preprocessing</h1>

<p>Here&#39;s a reference implementation of a preprocessing algorithm that performs many of the manipulations suggested in last week&#39;s lab:</p>

<pre class="knitr"><div class="source"><span class="symbol">preprocess</span> <span class="assignement">&lt;-</span> <span class="keyword">function</span><span class="keyword">(</span><span class="formalargs">table</span><span class="keyword">,</span> <span class="formalargs">dataName</span><span class="keyword">)</span> <span class="keyword">{</span>

  <span class="comment">#Calculate Cy5 / Cy3 ratio (Ch1 / Ch2)</span>
  <span class="symbol">ratios</span> <span class="assignement">&lt;-</span> <span class="symbol">table</span><span class="keyword">$</span><span class="symbol">CH1D_MEAN</span> <span class="keyword">/</span> <span class="symbol">table</span><span class="keyword">$</span><span class="symbol">CH2D_MEAN</span>

  <span class="comment">#Filter bad (negative) ratio values</span>
  <span class="symbol">ratios</span><span class="keyword">[</span><span class="symbol">ratios</span> <span class="keyword">&lt;</span> <span class="number">0</span><span class="keyword">]</span> <span class="assignement">&lt;-</span> <span class="number">NA</span>

  <span class="comment">#Log2 transform ratios</span>
  <span class="symbol">logRatio</span> <span class="assignement">&lt;-</span> <span class="functioncall">log</span><span class="keyword">(</span><span class="argument">x</span> <span class="argument">=</span> <span class="symbol">ratios</span><span class="keyword">,</span> <span class="argument">base</span> <span class="argument">=</span> <span class="number">2</span><span class="keyword">)</span>
  <span class="symbol">logRatio</span><span class="keyword">[</span><span class="symbol">logRatio</span> == <span class="number">NaN</span> <span class="keyword">|</span> <span class="symbol">logRatio</span> == <span class="number">Inf</span> <span class="keyword">|</span> <span class="symbol">logRatio</span> == <span class="keyword">-</span><span class="number">Inf</span><span class="keyword">]</span> <span class="assignement">&lt;-</span> <span class="number">NA</span>

  <span class="comment">#Global median normalization (median Log2(Cy5/Cy3) == 0)</span>
  <span class="symbol">medianRatio</span> <span class="assignement">&lt;-</span> <span class="functioncall">median</span><span class="keyword">(</span><span class="symbol">logRatio</span><span class="keyword">,</span> <span class="argument">na.rm</span> <span class="argument">=</span> <span class="number">TRUE</span><span class="keyword">)</span>
  <span class="symbol">normalizedRatios</span> <span class="assignement">&lt;-</span> <span class="symbol">logRatio</span> <span class="keyword">-</span> <span class="symbol">medianRatio</span>

  <span class="functioncall">return</span><span class="keyword">(</span><span class="symbol">normalizedRatios</span><span class="keyword">)</span>

<span class="keyword">}</span></div></pre>
</section>
<section><h1>Hierarchical clustering</h1>

<p>This wrapper function uses loadTables and preprocessing above to load a set of microarray tables from the DeRisi &#39;96 data set and constructs a hierarchical cluster heatmap.:</p>

<pre class="knitr"><div class="source"><span class="symbol">analyzeArrays</span> <span class="assignement">&lt;-</span> <span class="keyword">function</span><span class="keyword">(</span><span class="formalargs">dataPath</span><span class="keyword">,</span> <span class="formalargs">platformFile</span><span class="keyword">)</span> <span class="keyword">{</span>

  <span class="comment">#Load data.frame's from the given path</span>
  <span class="symbol">tables</span> <span class="assignement">&lt;-</span> <span class="functioncall">loadTables</span><span class="keyword">(</span><span class="symbol">dataPath</span><span class="keyword">)</span>

  <span class="comment">#Load platform annotation information</span>
  <span class="symbol">platform</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.delim</span><span class="keyword">(</span><span class="symbol">platformFile</span><span class="keyword">)</span>

  <span class="comment">#Create a data.frame to hold the normalized data</span>
  <span class="symbol">normalizedData</span> <span class="assignement">&lt;-</span> <span class="functioncall">data.frame</span><span class="keyword">(</span><span class="argument">ORF</span> <span class="argument">=</span> <span class="symbol">platform</span><span class="keyword">$</span><span class="symbol">ID..ORF</span><span class="keyword">)</span>

  <span class="comment">#For each file that was loaded as a data.frame in our list</span>
  <span class="keyword">for</span> <span class="keyword">(</span><span class="symbol">dataName</span> <span class="keyword">in</span> <span class="functioncall">names</span><span class="keyword">(</span><span class="symbol">tables</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">{</span>

    <span class="functioncall">message</span><span class="keyword">(</span><span class="string">"Analyzing: "</span><span class="keyword">,</span> <span class="symbol">dataName</span><span class="keyword">)</span>

    <span class="symbol">table</span> <span class="assignement">&lt;-</span> <span class="symbol">tables</span><span class="keyword">[[</span><span class="symbol">dataName</span><span class="keyword">]</span><span class="keyword">]</span>
    <span class="symbol">normalizedValues</span> <span class="assignement">&lt;-</span> <span class="functioncall">preprocess</span><span class="keyword">(</span><span class="symbol">table</span><span class="keyword">,</span> <span class="symbol">dataName</span><span class="keyword">)</span>
    <span class="symbol">normalizedData</span><span class="keyword">[[</span><span class="symbol">dataName</span><span class="keyword">]</span><span class="keyword">]</span> <span class="assignement">&lt;-</span> <span class="symbol">normalizedValues</span>

  <span class="keyword">}</span>

  <span class="comment">#Create a matrix that we can use as the source for clustering with heatmap</span>
  <span class="symbol">clusterMatrix</span> <span class="assignement">&lt;-</span> <span class="functioncall">as.matrix</span><span class="keyword">(</span> <span class="symbol">normalizedData</span><span class="keyword">[</span><span class="number">2</span><span class="keyword">:</span><span class="functioncall">ncol</span><span class="keyword">(</span><span class="symbol">normalizedData</span><span class="keyword">)</span><span class="keyword">]</span> <span class="keyword">)</span>

  <span class="comment">#For simplicity, filter out any rows with missing data</span>
  <span class="symbol">clusterMatrix</span> <span class="assignement">&lt;-</span> <span class="symbol">clusterMatrix</span><span class="keyword">[</span><span class="functioncall">apply</span><span class="keyword">(</span><span class="symbol">clusterMatrix</span><span class="keyword">,</span>
                                       <span class="argument">MARGIN</span> <span class="argument">=</span> <span class="number">1</span><span class="keyword">,</span>
                                       <span class="argument">FUN</span>    <span class="argument">=</span> <span class="keyword">function</span><span class="keyword">(</span><span class="formalargs">x</span><span class="keyword">)</span> <span class="keyword">{</span>
                                                  <span class="keyword">!</span><span class="number">NA</span> <span class="keyword">%in%</span> <span class="symbol">x</span>
                                                <span class="keyword">}</span>
                                       <span class="keyword">)</span><span class="keyword">,</span>
                                 <span class="keyword">]</span>


  <span class="comment">#Load gplots, which provides the colorpanel function</span>
  <span class="functioncall">library</span><span class="keyword">(</span><span class="symbol">gplots</span><span class="keyword">)</span>

  <span class="comment">#Use heatmap to perform clustering</span>
  <span class="functioncall">heatmap</span><span class="keyword">(</span><span class="symbol">clusterMatrix</span><span class="keyword">,</span>

          <span class="comment">#Skip clustering columns</span>
          <span class="argument">Colv</span>  <span class="argument">=</span> <span class="number">NA</span><span class="keyword">,</span>

          <span class="comment">#Load a pretty Blue-to-black-to-yellow color pallet</span>
          <span class="argument">col</span>   <span class="argument">=</span> <span class="functioncall">colorpanel</span><span class="keyword">(</span><span class="number">100</span><span class="keyword">,</span><span class="string">"royalblue3"</span><span class="keyword">,</span><span class="string">"black"</span><span class="keyword">,</span><span class="string">"yellow"</span><span class="keyword">)</span><span class="keyword">,</span>

          <span class="comment">#Set color saturation values at log2 of -2 to 2</span>
          <span class="comment">#zlim = c( -2, 2),</span>

          <span class="comment">#Hide gene labels because they will be too small to read</span>
          <span class="argument">labRow</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="string">""</span><span class="keyword">)</span>

          <span class="keyword">)</span>

  <span class="functioncall">return</span><span class="keyword">(</span><span class="symbol">normalizedData</span><span class="keyword">)</span>

<span class="keyword">}</span></div></pre>
</section>
<section><h1>Heatmaps of background intensity values</h1>

<p>The function below takes a vector of background intensity values from the DeRisi &#39;96 microarray dataset and makes a heatmap plot of those intesities across the surface of the microarray.</p>

<pre class="knitr"><div class="source"><span class="symbol">plotBackground</span> <span class="assignement">&lt;-</span> <span class="keyword">function</span><span class="keyword">(</span><span class="formalargs">backgroundIntensities</span><span class="keyword">,</span> <span class="formalargs">plotName</span> <span class="eqformalargs">=</span> <span class="string">""</span><span class="keyword">)</span> <span class="keyword">{</span>

  <span class="symbol">sector1</span> <span class="assignement">&lt;-</span> <span class="functioncall">matrix</span><span class="keyword">(</span><span class="symbol">backgroundIntensities</span><span class="keyword">[</span><span class="number">1</span><span class="keyword">:</span><span class="number">1600</span><span class="keyword">]</span><span class="keyword">,</span> <span class="argument">nrow</span> <span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">ncol</span><span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">byrow</span> <span class="argument">=</span> <span class="number">TRUE</span><span class="keyword">)</span>
  <span class="symbol">sector2</span> <span class="assignement">&lt;-</span> <span class="functioncall">matrix</span><span class="keyword">(</span><span class="symbol">backgroundIntensities</span><span class="keyword">[</span><span class="number">1601</span><span class="keyword">:</span><span class="number">3200</span><span class="keyword">]</span><span class="keyword">,</span> <span class="argument">nrow</span> <span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">ncol</span><span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">byrow</span> <span class="argument">=</span> <span class="number">TRUE</span><span class="keyword">)</span>
  <span class="symbol">topBlocks</span> <span class="assignement">&lt;-</span> <span class="functioncall">cbind</span><span class="keyword">(</span><span class="symbol">sector1</span><span class="keyword">,</span> <span class="symbol">sector2</span><span class="keyword">)</span>

  <span class="symbol">sector3</span> <span class="assignement">&lt;-</span> <span class="functioncall">matrix</span><span class="keyword">(</span><span class="symbol">backgroundIntensities</span><span class="keyword">[</span><span class="number">3201</span><span class="keyword">:</span><span class="number">4800</span><span class="keyword">]</span><span class="keyword">,</span> <span class="argument">nrow</span> <span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">ncol</span><span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">byrow</span> <span class="argument">=</span> <span class="number">TRUE</span><span class="keyword">)</span>
  <span class="symbol">sector4</span> <span class="assignement">&lt;-</span> <span class="functioncall">matrix</span><span class="keyword">(</span><span class="symbol">backgroundIntensities</span><span class="keyword">[</span><span class="number">4801</span><span class="keyword">:</span><span class="number">6400</span><span class="keyword">]</span><span class="keyword">,</span> <span class="argument">nrow</span> <span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">ncol</span><span class="argument">=</span> <span class="number">40</span><span class="keyword">,</span> <span class="argument">byrow</span> <span class="argument">=</span> <span class="number">TRUE</span><span class="keyword">)</span>
  <span class="symbol">bottomBlocks</span> <span class="assignement">&lt;-</span> <span class="functioncall">cbind</span><span class="keyword">(</span><span class="symbol">sector3</span><span class="keyword">,</span> <span class="symbol">sector4</span><span class="keyword">)</span>

  <span class="symbol">imageBlocks</span> <span class="assignement">&lt;-</span> <span class="functioncall">rbind</span><span class="keyword">(</span><span class="symbol">topBlocks</span><span class="keyword">,</span> <span class="symbol">bottomBlocks</span><span class="keyword">)</span>

  <span class="functioncall">filled.contour</span><span class="keyword">(</span><span class="number">1</span><span class="keyword">:</span><span class="number">80</span><span class="keyword">,</span> <span class="number">1</span><span class="keyword">:</span><span class="number">80</span><span class="keyword">,</span>
                 <span class="symbol">imageBlocks</span><span class="keyword">,</span>
                 <span class="argument">col</span>  <span class="argument">=</span> <span class="functioncall">heat.colors</span><span class="keyword">(</span><span class="number">20</span><span class="keyword">)</span><span class="keyword">,</span>
                 <span class="argument">main</span> <span class="argument">=</span> <span class="functioncall">paste</span><span class="keyword">(</span><span class="string">"Background intensities ("</span><span class="keyword">,</span> <span class="symbol">plotName</span><span class="keyword">,</span> <span class="string">")"</span><span class="keyword">,</span> <span class="argument">sep</span> <span class="argument">=</span> <span class="string">""</span><span class="keyword">)</span>
                 <span class="keyword">)</span>

<span class="keyword">}</span></div></pre>
</section>
  </div>
  <!-- end of courser content -->

  <!-- JavaScript at the bottom for fast page loading -->
  <script src=js/vendor/jquery-1.7.2.min.js type="text/javascript"></script>
  <script src=js/plugins.js type="text/javascript"></script>
  <script src=js/main.js type="text/javascript"></script>
  <script src=js/vendor/reveal.js type="text/javascript"></script>

</body>
</html>
